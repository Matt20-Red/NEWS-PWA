<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="manifest" href="/manifest.json">
<title>通知PWA</title>
<style>
  body{font-family:system-ui, sans-serif;max-width:640px;margin:24px auto;padding:0 12px}
  input,textarea,button{font:inherit;padding:8px;border-radius:8px;border:1px solid #ccc}
  textarea{width:100%;height:100px}
  .row{display:flex;gap:8px;margin:8px 0}
  .grow{flex:1}
</style>
<body>
<h1 style="font-weight:600">通知PWA</h1>

<div class="row">
  <input id="code" class="grow" placeholder="共有コード">
  <button id="btn-sub">購読</button>
  <button id="btn-unsub">購読解除</button>
</div>

<textarea id="message" placeholder="メッセージ"></textarea>
<div class="row">
  <button id="btn-send" class="grow">送信</button>
</div>
  
<!-- ★ここに追加 -->
<button id="btn-local">ローカル通知テスト</button>
<button id="btn-self">自分にテスト送信</button>
<button id="btn-apple">Apple限定送信</button>
  
<pre id="log"></pre>

<script>
const log = (...a)=>{ const p=document.getElementById('log'); p.textContent += a.join(' ') + '\n'; }

// ★ SWは一度だけ登録
(async () => {
  if ('serviceWorker' in navigator) {
    try {
      const reg = await navigator.serviceWorker.register('/sw.js');
      console.log('SW registered scope:', reg.scope);
      log('SW登録OK scope:', reg.scope);
    } catch (e) {
      console.error('SW register failed:', e);
      log('SW登録失敗:', e?.message || e);
    }
  } else {
    log('SW非対応環境');
  }
})();

(async function main(){
  if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
    log('このブラウザはPush非対応です'); return;
  }

  // ★ ここでは register しない。ready を待つだけ。
  const reg = await navigator.serviceWorker.ready;
  log('SW ready');

  const VAPID_PUBLIC_KEY = 'BAV2ymIPqjBiWKHBUuklJIrJhr-Yk-8AXEzZp6RfbANML4W9XdQ4aqz-ZerM49qHvRn5l0VFUsVSXucnaQsTppI';

  const keyToUint8 = (base64url) => {
    const padding = '='.repeat((4 - base64url.length % 4) % 4);
    const base64 = (base64url + padding).replace(/-/g,'+').replace(/_/g,'/');
    const raw = atob(base64);
    const out = new Uint8Array(raw.length);
    for (let i=0;i<raw.length;i++) out[i] = raw.charCodeAt(i);
    return out;
  };

  async function getSub(){
    const existing = await reg.pushManager.getSubscription();
    if (existing) return existing;
    return reg.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: keyToUint8(VAPID_PUBLIC_KEY)
    });
  }

  document.getElementById('btn-sub').onclick = async () => {
    try {
      const code = document.getElementById('code').value.trim();
      if (!code) return alert('コードを入力');

      const perm = await Notification.requestPermission();
      log('通知許可ステータス:', perm);
      if (perm !== 'granted') { log('通知が許可されませんでした'); return; }

      const sub = await getSub();
      log('購読endpoint:', sub.endpoint.slice(0, 48) + '...');

      const r = await fetch('/api/subscribe', {
        method:'POST',headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ code, subscription: sub })
      });
      // log('subscribe status:', r.status);
      // const j = await r.json();
      // log('購読登録結果:', JSON.stringify(j));
      log('subscribe status:', r.status);
      if (!r.ok) {
        const t = await r.text();
        log('subscribe ERROR body:', t.slice(0,200));
        return;
      }
      const j = await r.json();
      log('購読登録結果:', JSON.stringify(j));
    } catch (e) {
      log('購読処理エラー:', e?.message || e);
    }
  };

  document.getElementById('btn-unsub').onclick = async () => {
    try {
      const code = document.getElementById('code').value.trim();
      if (!code) return alert('コードを入力');
      const sub = await reg.pushManager.getSubscription();
      if (!sub) return log('未購読です');

      await sub.unsubscribe().catch(()=>{});
      const r = await fetch('/api/unsubscribe', {
        method:'POST',headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ code, endpoint: sub.endpoint })
      });
      log('unsubscribe status:', r.status);
      const j = await r.json();
      log('購読解除結果:', JSON.stringify(j));
    } catch (e) {
      log('購読解除エラー:', e?.message || e);
    }
  };

  document.getElementById('btn-send').onclick = async () => {
    try {
      log('send click: handler start');  // ← クリック開始ログ
      const code = document.getElementById('code').value.trim();
      const message = document.getElementById('message').value;
      // if (!code || !message) return alert('コードとメッセージを入力');
      if (!code) { log('send stop: code empty'); alert('コードを入力'); return; }
      if (!message) { log('send stop: message empty'); alert('メッセージを入力'); return; }
      
      const r = await fetch('/api/broadcast', {
        method:'POST',headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ code, message })
      });
      log('broadcast status:', r.status);
      // const j = await r.json();
      // log('送信結果:', JSON.stringify(j));
      // if (j.errors && j.errors.length) { log('エラー例:', j.errors[0].error); }
      if (!r.ok) {
        const t = await r.text();
        log('broadcast error body:', t.slice(0,400));
        return;
      }
      const j = await r.json().catch(e => ({ parseError: String(e) }));
      log('送信結果:', JSON.stringify(j));
      if (j?.errors?.length) { log('エラー例:', j.errors[0].error); }
    } catch (e) {
      log('送信時エラー:', e?.message || e);
    }
  };

  document.getElementById('btn-local').onclick = async () => {
    const reg = await navigator.serviceWorker.ready;
    await reg.showNotification('通知(ローカル)', {
      body: 'SW.showNotification からのテスト',
      icon: '/icon-192.png',   // 必要なら manifest のアイコンに合わせる
      badge: '/icon-192.png',
      data: { url: '/' },
    });
    log('local notification requested');
  };

  document.getElementById('btn-self').onclick = async () => {
  try {
    log('self-send: start');
    const reg = await navigator.serviceWorker.ready;
    let sub = await reg.pushManager.getSubscription();
    if (!sub) {
      alert('先に購読してください'); return;
    }
    const r = await fetch('/api/push-one', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ message: 'self test', subscription: sub })
    });
    log('self-send status:', r.status);
    const t = await r.text();
    log('self-send body:', t.slice(0,300));
  } catch (e) {
    log('self-send error:', e?.message || e);
  }
  };

document.getElementById('btn-apple').onclick = async () => {
  const code = document.getElementById('code').value.trim();
  const message = document.getElementById('message').value || 'apple only';
  if (!code) return alert('コードを入力');
  const r = await fetch('/api/broadcast-apple', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ code, message })
  });
  log('apple-only status:', r.status);
  log('apple-only body:', (await r.text()).slice(0,400));
};
  
})();
</script>


<script>
if (navigator.serviceWorker) {
  navigator.serviceWorker.addEventListener('message', (e) => {
    const m = e.data || {};
    if (m.__debug === 'push-received') {
      log('SW says: push-received', JSON.stringify({ title: m.title, hasBody: !!m.body, url: m.url }));
    }
    // __open が届いたら上書き遷移（null は無視）
    if (Object.prototype.hasOwnProperty.call(m, '__open')) {
      if (m.__open) {
        try { location.replace(m.__open); } catch {}
      }
    }
  });
}


/* BroadcastChannel でも受け取って上書き遷移 */
try {
  const bc = new BroadcastChannel('sw-bridge');
  bc.onmessage = (e) => {
    const m = e.data || {};
    if (m.__open) {
      try { location.replace(m.__open); } catch {}
    }
  };
} catch {}

  
/* 前面化したら SW に「最後のURLある？」と問い合わせ */
function requestLastOpen() {
  const ctrl = navigator.serviceWorker && navigator.serviceWorker.controller;
  if (ctrl) {
    try { ctrl.postMessage({ __req_open: true }); } catch {}
  }
}
document.addEventListener('visibilitychange', () => {
  if (!document.hidden) setTimeout(requestLastOpen, 0);
});
window.addEventListener('pageshow', () => setTimeout(requestLastOpen, 0));
window.addEventListener('focus', () => setTimeout(requestLastOpen, 0));

</script>

</body>
</html>
